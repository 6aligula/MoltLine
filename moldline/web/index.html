<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MoldLine</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 20px; }
    .row { display: flex; gap: 12px; align-items: flex-start; }
    .col { flex: 1; border: 1px solid #ddd; padding: 12px; border-radius: 8px; }
    .msgs { height: 320px; overflow: auto; border: 1px solid #eee; padding: 8px; margin: 8px 0; background: #fafafa; }
    .msg { margin: 4px 0; }
    .meta { color: #666; font-size: 12px; }
    .err { color: #b00020; font-size: 12px; white-space: pre-wrap; }
    input, button, select { padding: 8px; }
    button { cursor: pointer; }
    ul { margin: 8px 0; padding-left: 18px; }
    li { margin: 6px 0; }
    .rooms { max-height: 180px; overflow: auto; border: 1px solid #eee; padding: 8px; background: #fff; }
    .roomRow { display:flex; gap:8px; align-items:center; justify-content:space-between; margin: 6px 0; }
    code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }
  </style>
</head>
<body>
  <h1>MoldLine (local demo)</h1>
  <p class="meta">Open this page twice (two browser windows). One as user A, one as user B.</p>

  <div class="row">
    <div class="col">
      <h2>Client</h2>

      <div class="row" style="gap:10px;">
        <div>
          User:
          <select id="user">
            <option value="a">a (User A)</option>
            <option value="b">b (User B)</option>
          </select>
        </div>
        <div>
          <button id="connect">Connect WS</button>
        </div>
      </div>

      <div class="meta" id="status">disconnected</div>
      <div class="err" id="err"></div>

      <hr />

      <h3>Direct message (DM)</h3>
      <div>
        DM with:
        <select id="other">
          <option value="b">b</option>
          <option value="a">a</option>
        </select>
        <button id="startDm">Start/Load DM</button>
      </div>

      <hr />

      <h3>Rooms</h3>
      <div class="row" style="gap:10px;">
        <input id="roomName" placeholder="New room name" style="flex:1" />
        <button id="createRoom">Create</button>
        <button id="refreshRooms">Refresh</button>
      </div>

      <div class="rooms" id="rooms"></div>

      <div class="meta" style="margin-top:8px;" id="active">Active: none</div>

      <div class="msgs" id="msgs"></div>

      <div>
        <input id="text" placeholder="Type message..." style="width: 70%" />
        <button id="send">Send</button>
      </div>
    </div>

    <div class="col">
      <h2>Notes</h2>
      <ul>
        <li>Server: <code>node server.js</code> on port 8787</li>
        <li>WebSocket: <code>ws://localhost:8787?userId=a</code> (or b)</li>
        <li>Auth is just <code>x-user-id</code> header (dev only)</li>
        <li>Rooms API (backend): <code>POST /rooms</code>, <code>POST /rooms/:id/join</code>, <code>GET /rooms</code></li>
      </ul>
    </div>
  </div>

<script>
  const API = location.origin.replace(/:\d+$/, ':8787');
  let ws = null;
  let active = null; // { type:'dm'|'room', convoId, label }

  function el(id){ return document.getElementById(id); }
  function setErr(e){ el('err').textContent = e ? String(e) : ''; }

  function clearMsgs(){ el('msgs').innerHTML = ''; }
  function logMsg(m){
    const div = document.createElement('div');
    div.className = 'msg';
    const ts = new Date(m.ts).toLocaleTimeString();
    div.textContent = `[${ts}] ${m.from}: ${m.text}`;
    el('msgs').appendChild(div);
    el('msgs').scrollTop = el('msgs').scrollHeight;
  }

  async function api(path, opts={}){
    const userId = el('user').value;
    const res = await fetch(API + path, {
      ...opts,
      headers: {
        'Content-Type': 'application/json',
        'x-user-id': userId,
        ...(opts.headers || {})
      }
    });
    const text = await res.text();
    let data;
    try { data = text ? JSON.parse(text) : {}; } catch { data = { raw: text }; }
    if (!res.ok) throw new Error(`${res.status}: ${JSON.stringify(data)}`);
    return data;
  }

  function setActive(a){
    active = a;
    el('active').textContent = active ? `Active: ${active.type.toUpperCase()} ${active.label} (${active.convoId})` : 'Active: none';
  }

  function ensureWS(){
    const userId = el('user').value;
    if (ws && ws.readyState === WebSocket.OPEN) return;
    if (ws) ws.close();
    ws = new WebSocket(`ws://localhost:8787?userId=${userId}`);
    el('status').textContent = 'connecting...';
    ws.onopen = () => { el('status').textContent = 'connected'; };
    ws.onclose = () => { el('status').textContent = 'disconnected'; };
    ws.onerror = (e) => { setErr('WS error'); console.error(e); };
    ws.onmessage = (ev) => {
      const msg = JSON.parse(ev.data);
      if (msg.type === 'message') {
        if (!active || msg.data.convoId !== active.convoId) return;
        logMsg(msg.data);
      }
    };
  }

  el('connect').onclick = () => { setErr(''); ensureWS(); };

  el('startDm').onclick = async () => {
    try {
      setErr('');
      ensureWS();
      clearMsgs();
      const otherUserId = el('other').value;
      const out = await api('/dm', { method: 'POST', body: JSON.stringify({ otherUserId }) });
      const convoId = out.convoId;
      setActive({ type:'dm', convoId, label: `with ${otherUserId}` });
      const msgs = await api(`/conversations/${convoId}/messages`);
      msgs.forEach(logMsg);
    } catch (e) {
      setErr(e);
    }
  };

  async function loadRooms(){
    el('rooms').innerHTML = '';
    let rooms = [];
    try {
      // Preferred: backend /rooms
      rooms = await api('/rooms');
    } catch (e) {
      // Fallback: /conversations filter
      try {
        const convos = await api('/conversations');
        rooms = convos.filter(c => c.kind === 'room').map(c => ({ roomId: c.convoId, name: c.convoId, memberCount: (c.members||[]).length }));
      } catch (e2) {
        setErr(e);
        return;
      }
    }

    if (!rooms.length) {
      el('rooms').innerHTML = '<div class="meta">No rooms yet</div>';
      return;
    }

    for (const r of rooms) {
      const row = document.createElement('div');
      row.className = 'roomRow';
      const left = document.createElement('div');
      left.innerHTML = `<b>${escapeHtml(r.name || r.roomId)}</b><div class="meta">${escapeHtml(r.roomId)} â€¢ members: ${r.memberCount ?? '?'}</div>`;
      const btn = document.createElement('button');
      btn.textContent = 'Open';
      btn.onclick = () => openRoom(r.roomId, r.name);
      row.appendChild(left);
      row.appendChild(btn);
      el('rooms').appendChild(row);
    }
  }

  async function openRoom(roomId, name){
    try {
      setErr('');
      ensureWS();
      clearMsgs();
      // join (idempotent)
      try { await api(`/rooms/${roomId}/join`, { method: 'POST' }); } catch {}
      setActive({ type:'room', convoId: roomId, label: name || roomId });
      const msgs = await api(`/conversations/${roomId}/messages`);
      msgs.forEach(logMsg);
    } catch (e) {
      setErr(e);
    }
  }

  el('createRoom').onclick = async () => {
    try {
      setErr('');
      const name = el('roomName').value.trim();
      if (!name) return;
      const out = await api('/rooms', { method: 'POST', body: JSON.stringify({ name }) });
      el('roomName').value = '';
      await loadRooms();
      await openRoom(out.roomId, out.name);
    } catch (e) {
      setErr(e);
    }
  };

  el('refreshRooms').onclick = () => loadRooms();

  el('send').onclick = async () => {
    try {
      setErr('');
      const text = el('text').value.trim();
      if (!text || !active) return;
      el('text').value = '';
      await api(`/conversations/${active.convoId}/messages`, { method: 'POST', body: JSON.stringify({ text }) });
    } catch (e) {
      setErr(e);
    }
  };

  el('text').addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      el('send').click();
    }
  });

  function escapeHtml(s){
    return String(s).replace(/[&<>"]/g, (c) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
  }

  // Initial rooms load (best-effort)
  loadRooms().catch(() => {});
</script>
</body>
</html>
